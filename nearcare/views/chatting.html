{% extends 'index.html' %}
{% block content %}
    <div id="div_chatting_page_content_all">
        <div id="div_chatting_page_title">
            <p>AI 챗봇</p>
        </div>
        

        <div id="div_chatting_page_content"><!--전체내용-->

            <div class="div1_chatting_space" id="chatbotMessages"><!--채팅공간-->
                
                <!--gpt 말풍선-->
                <div class="div_chat_bubble_group_gpt" >
                    <!--gpt 프로필-->
                    <div class="div_img_profile_chatbot_bg">
                            <img src="/images/profile_chatbot_icon.png" class="img_profile_chatbot_icon">
                    </div>
                    
                    <!-- ai 말풍선 -->
                    <div class="div_chat_bubble_big_gpt">
                        <span class="span_text_gpt">안녕하세요. 따숨 챗봇입니다. 무엇을 도와드릴까요?</span>
                    </div>
                </div> <!-- gpt 말풍선 끝-->

                <!--사용자 말풍선-->
                <!-- <div class="div_chat_bubble_group_user">
                    <div class="div_chat_bubble_big_user">
                        <span class="span_chat_bubble_text_user">뭐라뭐라</span>
                    </div>
                </div> -->
               
                
            </div>
        
        

            <div class="div2_sending_space">
                <div id="div_chat_all">
                    <form id="chatForm" method="post">
                        <label for="input_chat"></label>
                        <input class="input_chat" type="text" id="input_chat" name="userInputText">
                        <button class="btn_chat" type="submit" id="btn_chat">
                            <!-- <div class="btn_chat_bg"></div> -->
                            <img src = "../images/chat_airplane.png" class="btn_chat_airplane">
                            
                        </button>
                    </form>
                </div>
            </div>
        </div>

    </div>
    </div>

<script>
    document.getElementById('chatForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const userInput = document.getElementById('input_chat').value;
        if (userInput.trim() === '') return;

        // 사용자 입력을 화면에 표시
        const userMessages = document.getElementById('chatbotMessages');
        const userMessageDiv = document.createElement('div');
        userMessageDiv.classList.add('div_chat_bubble_group_user');
        userMessageDiv.innerHTML = `
            <div class="div_chat_bubble_big_user">
                <span class="span_chat_bubble_text_user">${userInput}</span>
            </div>
        `;
        userMessages.appendChild(userMessageDiv);

        // 서버로 사용자 입력 전송
        try {
            const response = await fetch('/chatting/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userInputText: userInput })
            });

            const data = await response.json();
            const chatbotMessages = document.getElementById('chatbotMessages');

            if (data.gptResponse) {
                // ChatGPT 응답을 화면에 표시
                const chatbotMessageDiv = document.createElement('div');
                chatbotMessageDiv.classList.add('div_chat_bubble_group_gpt');
                chatbotMessageDiv.innerHTML = `
                    <div class="div_img_profile_chatbot_bg">
                        <img src="/images/profile_chatbot_icon.png" class="img_profile_chatbot_icon">
                    </div>
                    <div class="div_chat_bubble_big_gpt">
                        <span class="span_text_gpt"></span>
                    </div>
                `;
                chatbotMessages.appendChild(chatbotMessageDiv);
                // 자영 타이핑 하는 효과 추가 
                const textElement = chatbotMessageDiv.querySelector('.span_text_gpt');
                let index = 0;

                function typeWriter() {
                    if (index < data.gptResponse.length) {
                        textElement.innerHTML += data.gptResponse.charAt(index);
                        index++;
                        setTimeout(typeWriter, 30); // 타이핑 속도 조절 (밀리초 단위)
                    }
                }

                typeWriter();
            } else {
                console.error('ChatGPT 응답 없음');
            }
        } catch (error) {
            console.error('오류 발생:', error);
        }

        // 입력 필드 비우기
        document.getElementById('input_chat').value = '';
    });
</script>
{% endblock %}